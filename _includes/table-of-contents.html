<div id="table-of-contents" class="article-toc">
  <strong>В этой статье:</strong>
  <nav class="toc-nav" id="toc-nav">
    <!-- Оглавление будет сгенерировано JavaScript -->
  </nav>
</div>

<script>
(function() {
  function initTableOfContents() {
    // Функция для создания уникального ID из текста
    function createId(text) {
      return text
        .toLowerCase()
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
    }

    // Находим контейнер с контентом статьи
    const postContent = document.querySelector('.post-content');
    if (!postContent) {
      // Скрываем оглавление, если контента нет
      const tocContainer = document.getElementById('table-of-contents');
      if (tocContainer) {
        tocContainer.style.display = 'none';
        return;
      }
      return;
    }

    // Находим только заголовки h2
    const allHeadings = postContent.querySelectorAll('h2');
    if (allHeadings.length === 0) {
      // Скрываем оглавление, если заголовков нет
      const tocContainer = document.getElementById('table-of-contents');
      if (tocContainer) {
        tocContainer.style.display = 'none';
        return;
      }
    }

    // Используем все h2 заголовки
    const headings = Array.from(allHeadings);

    // Создаем оглавление
    const tocNav = document.getElementById('toc-nav');
    if (!tocNav) return;

  const tocList = document.createElement('ul');
  tocList.className = 'toc-list';

  headings.forEach((heading, index) => {
    // Создаем ID для заголовка
    let id = heading.id || createId(heading.textContent);
    heading.id = id;

    // Создаем элемент оглавления
    const tocItem = document.createElement('li');
    tocItem.className = 'toc-item toc-item-h2';

    const tocLink = document.createElement('a');
    tocLink.href = '#' + id;
    tocLink.textContent = heading.textContent;
    tocLink.className = 'toc-link';

    // Плавная прокрутка
    tocLink.addEventListener('click', function(e) {
      e.preventDefault();
      const target = document.getElementById(id);
      if (target) {
        const offset = 80; // Отступ от верха
        const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - offset;
        window.scrollTo({
          top: targetPosition,
          behavior: 'smooth'
        });
        // Обновляем активный элемент
        updateActiveTocItem(id);
      }
    });

    tocItem.appendChild(tocLink);
    tocList.appendChild(tocItem);
  });

  tocNav.appendChild(tocList);

  // Функция для обновления активного элемента при прокрутке
  function updateActiveTocItem(activeId) {
    const tocLinks = tocNav.querySelectorAll('.toc-link');
    tocLinks.forEach(link => {
      link.classList.remove('active');
      if (link.getAttribute('href') === '#' + activeId) {
        link.classList.add('active');
      }
    });
  }

  // Отслеживание прокрутки для подсветки активного раздела
  let ticking = false;
  function onScroll() {
    if (!ticking) {
      window.requestAnimationFrame(function() {
        const scrollPos = window.scrollY + 100;
        headings.forEach(heading => {
          const top = heading.offsetTop;
          const bottom = top + heading.offsetHeight;
          if (scrollPos >= top && scrollPos < bottom) {
            updateActiveTocItem(heading.id);
          }
        });
        ticking = false;
      });
      ticking = true;
    }
  }

  window.addEventListener('scroll', onScroll);
  // Инициализация при загрузке
  onScroll();
  }

  // Запускаем после загрузки DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTableOfContents);
  } else {
    initTableOfContents();
  }
})();
</script>

